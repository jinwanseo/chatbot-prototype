doctype html
html
    head
        title ChatBOT ì„¤ì •
        script(src="https://cdn.tailwindcss.com")
    body.flex.flex-col.w-screen.h-screen.items-center.bg-slate-900
        section.shadow.shadow-lg.p-6.flex.flex-col.gap-2.justify-center.h-screen.w-full
            h1.text-slate-300.text-center ëŒ€í™” ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ ë° ì‚­ì œ ğŸ‰
            div.flex.flex-row.gap-2.items-center.justify-start
                a.a.bg-sky-900.text-sky-50.text-xs.px-2.rounded(href=`/chat?chatId=1`) ëŒ€í™” í•˜ê¸°
                a.bg-teal-900.text-teal-50.text-xs.px-2.rounded(href=`/custom`) ëŒ€í™” ì„¤ì •
                a.a.bg-amber-900.text-sky-50.text-xs.px-2.rounded.cursor-pointer(href=`/topic`) ì£¼ì œ ì„¤ì •
                span.text-slate-300.text-xs.ml-auto ë™ì ìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”
            ul#messages.h-full.w-full.flex.flex-col.gap-5.bg-slate-800.text-sm.rounded.p-5.overflow-y-auto
                each item, index in result
                    li.bg-slate-700.rounded.p-2.mr-auto.text-slate-50.w-full(id=`message-${index}`)
                        div.flex.flex-row.w-full.gap-5.text-xs.justify-between.px-3
                            div.flex.flex-col.gap-2.w-14
                                span ì§ˆë¬¸
                                span ë‹µë³€
                            div.flex.flex-row.w-full.justify-between
                                div.flex.flex-col.gap-2
                                    span.w-full= item.question
                                    span.w-full= item.answer
                                div.flex.flex-row.gap-1.items-center
                                    button.bg-red-800.text-red-50.p-2.rounded(onclick=`deleteMessage('${index}','${item.question}', '${item.answer}')`) ì‚­ì œ
            form(action="" onsubmit="addMessage(event)" class="flex flex-row gap-2 w-full")
                div.flex.flex-col.w-full.text-xs.gap-1
                    div.flex.flex-row.gap-2.items-center.justify-center
                        span.text-slate-300.text-center.w-14 ì§ˆë¬¸
                        input#question.bg-slate-800.border.border-slate-400.rounded.rounded-lg.w-full.text-slate-300.px-3.p-2(placeholder="ì¶”ê°€í•  ì§ˆë¬¸ ì…ë ¥í•´ì¤˜ìš”", type="text", name="question", autocomplete="off")
                    div.flex.flex-row.gap-2.items-center.justify-center
                        span.text-slate-300.text-center.w-14 ë‹µë³€
                        input#answer.bg-slate-800.border.border-slate-400.rounded.rounded-lg.w-full.text-slate-300.px-3.p-2(placeholder="ì¶”ê°€í•  ë‹µë³€ì„ ì…ë ¥í•´ì¤˜ìš”", type="text", name="answer", autocomplete="off")
                    div.flex.flex-row.gap-2.items-center.justify-center.w-full
                        div.flex.flex-row.gap-2.items-center.justify-center.w-full
                            span#topics-label.text-slate-300.text-center.w-14 ì£¼ì œ ì´ë™
                            select#topics.bg-slate-800.border.border-slate-400.rounded.rounded-lg.w-full.text-slate-300.px-3.p-2(name="group", autocomplete="off")
                                option(value="") ì„ íƒ ì•ˆí•¨
                                    each topic in topics
                                        option(value=topic.title)= topic.title
                        div#question-area.flex.flex-row.gap-2.items-center.justify-center

                button.bg-sky-900.text-sky-50.p-3.text-xs.rounded.w-24(type="submit") ì €ì¥
        script.
            const topics = !{JSON.stringify(topics)};
            const baseURL = window.location.origin;
            const questionAreaElement = document.getElementById("question-area");

            // ì£¼ì œ ì´ë™ ì„ íƒì‹œ ì§ˆë¬¸ ì´ë™ ì»´í¬ë„ŒíŠ¸  ë™ì  ìƒì„±
            const onLinkTopicSelect = (event) => {
                // 1. í† í”½ ì„ íƒ ì—¬ë¶€ í™•ì¸
                if (!event.target.value) {
                    questionAreaElement.innerHTML = "";
                    questionAreaElement.classList.remove("w-full");
                    document.getElementById("topics-label").classList.remove("w-14");
                    return;
                }

                const selectedTopic = topics.find(t => t.title === event.target.value)
                if (!selectedTopic) {
                    alert("ì„ íƒí•œ ì£¼ì œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    return;
                }

                // 2. í† í”½ ì„ íƒ ë³€ê²½ì‹œ ì§ˆë¬¸ ì´ë™ ì •ë³´ ë¦¬ì…‹
                questionAreaElement.innerHTML = `
                                <span class="text-slate-300 text-center w-16">ì§ˆë¬¸ ì´ë™</span>
                                <select id="topic-question" class="bg-slate-800 border border-slate-400 rounded rounded-lg w-full text-slate-300 px-3 p-2" autocomplete="off">
                                    ${selectedTopic.questions.map(q => `<option value="${q}">${q}</option>`).join("")}
                                </select>
                            `;
                document.getElementById("topics-label").classList.add("w-16")

                questionAreaElement.classList.add("w-full");
            }

            // ì´ë²¤íŠ¸ ë“±ë¡ (ì£¼ì œ ì´ë™ ì„ íƒì‹œ)
            document.getElementById("topics").addEventListener("change", onLinkTopicSelect);

            // ë©”ì‹œì§€ ì¶”ê°€
            const addMessage = async (event) => {
                const questionElement = document.getElementById("question");
                const answerElement = document.getElementById("answer");
                const topicsElement = document.getElementById("topics");
                const topicQuestionElement = document.getElementById("topic-question");

                const data = {};


                if (!questionElement.value || !answerElement.value) {
                    alert("ì§ˆë¬¸ê³¼ ë‹µë³€ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                    return;
                }

                data.question = questionElement.value;
                data.answer = answerElement.value;

                if (topicsElement.value && !topicQuestionElement.value) {
                    alert("ì§ˆë¬¸ ì´ë™ì‹œ ìë™ìœ¼ë¡œ ì¶œë ¥ë  ì²« ì§ˆë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”");
                    return;
                }

                if (topicsElement.value && topicQuestionElement.value) {
                    data.topic = topicsElement.value;
                    data.topicQuestion = topicQuestionElement.value;
                }


                const response = await fetch(`${baseURL}/custom`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                });

                const res = await response.json();
                res.error && alert(res.error);
            }


            // 2. ë©”ì‹œì§€ ì‚­ì œ
            const deleteMessage = async (index, question, answer) => {
                const response = await fetch(`${baseURL}/custom`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        question: question,
                        answer: answer
                    })
                });

                const {result, error} = await response.json();
                if (error) {
                    alert(error);
                    return;
                }

                const messageElement = document.getElementById(`message-${index}`);
                messageElement.remove();
            }
